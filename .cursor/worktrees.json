{
  "maxAgents": 8,
  "lockTimeoutMinutes": 30,
  "setup-worktree-windows": [
    "$ErrorActionPreference = 'Stop'",
    "$coordParent = '..'",
    "$maxAgents = 8",
    "$lockTimeoutMinutes = 30",
    "$lockTimeoutMs = $lockTimeoutMinutes * 60 * 1000",
    "$timestamp = (Get-Date).ToUniversalTime().ToString('o')",
    "$agentId = $null",
    "$staleLocksCleaned = 0",
    "",
    "# Clean up stale locks",
    "for ($i=1; $i -le $maxAgents; $i++) {",
    "  $lockFile = \"$coordParent/.coord-$i.lock\"",
    "  if (Test-Path $lockFile) {",
    "    try {",
    "      $lockContent = Get-Content $lockFile -Raw -ErrorAction SilentlyContinue",
    "      if ($lockContent) {",
    "        $lockTime = [DateTime]::Parse($lockContent.Trim())",
    "        $age = ((Get-Date).ToUniversalTime() - $lockTime).TotalMilliseconds",
    "        if ($age -gt $lockTimeoutMs) {",
    "          Remove-Item $lockFile -Force -ErrorAction SilentlyContinue",
    "          $staleLocksCleaned++",
    "        }",
    "      }",
    "    } catch {",
    "      # If lock file is unreadable or invalid, remove it",
    "      Remove-Item $lockFile -Force -ErrorAction SilentlyContinue",
    "      $staleLocksCleaned++",
    "    }",
    "  }",
    "}",
    "",
    "# Try to acquire a lock",
    "for ($i=1; $i -le $maxAgents; $i++) {",
    "  $lockFile = \"$coordParent/.coord-$i.lock\"",
    "  if (!(Test-Path $lockFile)) {",
    "    try {",
    "      # Atomic write: create file with timestamp",
    "      Set-Content -Path $lockFile -Value $timestamp -NoNewline -ErrorAction Stop",
    "      # Verify we got the lock (check file still doesn't exist from another process)",
    "      Start-Sleep -Milliseconds 50",
    "      $verifyContent = Get-Content $lockFile -Raw -ErrorAction SilentlyContinue",
    "      if ($verifyContent -and $verifyContent.Trim() -eq $timestamp) {",
    "        Set-Content -Path '.agent-id' -Value $i -NoNewline",
    "        $agentId = $i",
    "        Write-Host \"✓ Acquired agent ID $i (cleaned $staleLocksCleaned stale lock(s))\" -ForegroundColor Green",
    "        # Load agent configuration if available",
    "        if (Test-Path '.cursor/agents.json') {",
    "          Write-Host \"Loading agent configuration...\" -ForegroundColor Cyan",
    "          & '.cursor/load-agent.ps1' -AgentId $i | Out-Null",
    "        }",
    "        break",
    "      }",
    "    } catch {",
    "      # Lock acquisition failed, try next slot",
    "      continue",
    "    }",
    "  }",
    "}",
    "",
    "if (-not $agentId) {",
    "  Write-Host \"✗ ERROR: All agent slots ($maxAgents) are occupied. Please wait or clean up stale locks manually.\" -ForegroundColor Red",
    "  Write-Host \"  Lock files: $coordParent/.coord-*.lock\" -ForegroundColor Yellow",
    "  exit 1",
    "}"
  ],
  "setup-worktree-unix": [
    "set -e",
    "COORD_PARENT='..'",
    "MAX_AGENTS=8",
    "LOCK_TIMEOUT_MINUTES=30",
    "LOCK_TIMEOUT_SEC=$((LOCK_TIMEOUT_MINUTES * 60))",
    "TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ 2>/dev/null || date -u +%Y-%m-%dT%H:%M:%SZ)",
    "AGENT_ID=",
    "STALE_LOCKS_CLEANED=0",
    "",
    "# Clean up stale locks",
    "for i in $(seq 1 $MAX_AGENTS); do",
    "  LOCK_FILE=\"$COORD_PARENT/.coord-$i.lock\"",
    "  if [ -f \"$LOCK_FILE\" ]; then",
    "    LOCK_TIME=$(cat \"$LOCK_FILE\" 2>/dev/null || echo '')",
    "    if [ -n \"$LOCK_TIME\" ]; then",
    "      # Convert lock time to Unix timestamp and compare",
    "      LOCK_EPOCH=$(date -d \"$LOCK_TIME\" +%s 2>/dev/null || date -j -f \"%Y-%m-%dT%H:%M:%S\" \"${LOCK_TIME%.*}\" +%s 2>/dev/null || echo 0)",
    "      if [ \"$LOCK_EPOCH\" -gt 0 ]; then",
    "        CURRENT_EPOCH=$(date +%s)",
    "        AGE=$((CURRENT_EPOCH - LOCK_EPOCH))",
    "        if [ $AGE -gt $LOCK_TIMEOUT_SEC ]; then",
    "          rm -f \"$LOCK_FILE\"",
    "          STALE_LOCKS_CLEANED=$((STALE_LOCKS_CLEANED + 1))",
    "        fi",
    "      else",
    "        # Invalid timestamp, remove lock",
    "        rm -f \"$LOCK_FILE\"",
    "        STALE_LOCKS_CLEANED=$((STALE_LOCKS_CLEANED + 1))",
    "      fi",
    "    else",
    "      # Empty or unreadable lock file, remove it",
    "      rm -f \"$LOCK_FILE\"",
    "      STALE_LOCKS_CLEANED=$((STALE_LOCKS_CLEANED + 1))",
    "    fi",
    "  fi",
    "done",
    "",
    "# Try to acquire a lock",
    "for i in $(seq 1 $MAX_AGENTS); do",
    "  LOCK_FILE=\"$COORD_PARENT/.coord-$i.lock\"",
    "  if [ ! -f \"$LOCK_FILE\" ]; then",
    "    # Atomic write: create file with timestamp",
    "    echo -n \"$TIMESTAMP\" > \"$LOCK_FILE\" 2>/dev/null || continue",
    "    # Small delay to check for race conditions",
    "    sleep 0.05",
    "    # Verify we got the lock",
    "    VERIFY_CONTENT=$(cat \"$LOCK_FILE\" 2>/dev/null || echo '')",
    "    if [ \"$VERIFY_CONTENT\" = \"$TIMESTAMP\" ]; then",
    "      echo -n \"$i\" > .agent-id",
    "      AGENT_ID=$i",
    "      echo \"✓ Acquired agent ID $i (cleaned $STALE_LOCKS_CLEANED stale lock(s))\"",
    "      # Load agent configuration if available",
    "      if [ -f '.cursor/agents.json' ]; then",
    "        echo \"Loading agent configuration...\"",
    "        bash .cursor/load-agent.sh $i > /dev/null 2>&1 || true",
    "      fi",
    "      break",
    "    fi",
    "  fi",
    "done",
    "",
    "if [ -z \"$AGENT_ID\" ]; then",
    "  echo \"✗ ERROR: All agent slots ($MAX_AGENTS) are occupied. Please wait or clean up stale locks manually.\" >&2",
    "  echo \"  Lock files: $COORD_PARENT/.coord-*.lock\" >&2",
    "  exit 1",
    "fi"
  ],
  "cleanup-worktree-windows": [
    "$ErrorActionPreference = 'Stop'",
    "$coordParent = '..'",
    "if (Test-Path '.agent-id') {",
    "  $agentId = Get-Content '.agent-id' -Raw -ErrorAction SilentlyContinue",
    "  if ($agentId) {",
    "    $agentId = $agentId.Trim()",
    "    $lockFile = \"$coordParent/.coord-$agentId.lock\"",
    "    if (Test-Path $lockFile) {",
    "      Remove-Item $lockFile -Force -ErrorAction SilentlyContinue",
    "      Write-Host \"✓ Released agent ID $agentId\" -ForegroundColor Green",
    "    }",
    "    Remove-Item '.agent-id' -Force -ErrorAction SilentlyContinue",
    "  }",
    "}"
  ],
  "cleanup-worktree-unix": [
    "set -e",
    "COORD_PARENT='..'",
    "if [ -f '.agent-id' ]; then",
    "  AGENT_ID=$(cat .agent-id 2>/dev/null || echo '')",
    "  if [ -n \"$AGENT_ID\" ]; then",
    "    LOCK_FILE=\"$COORD_PARENT/.coord-$AGENT_ID.lock\"",
    "    rm -f \"$LOCK_FILE\"",
    "    echo \"✓ Released agent ID $AGENT_ID\"",
    "    rm -f .agent-id",
    "  fi",
    "fi"
  ]
}
